WebGL Forward+ and Clustered Deferred Shading
======================

**University of Pennsylvania, CIS 565: GPU Programming and Architecture, Project 5**

* Xiao Wei
* Tested on: Windows 10, i9-9900K @ 3.6GHz 16.0GB, RTX 2080 Super, 16GB

### Live Online

https://WillTheFabulous.github.io/Project5-WebGL-Forward-Plus-and-Clustered-Deferred/


Description
======================
The project contains different methods of rendering a scene with a lot of light sources. The default Forward shading iterate through all the light sources in the scene to compute their contribution to the pixel. We can process the light sources before rendering into some data structure called cluster and only shade relevent light for the particular pixel and this method is called Forward+ rendering. The same idea can be applied to deferred shading, with which we will only sample precomputed gbuffer textures that contains position, normal, and albedo information so that we avoid shading fragments that will eventually be culled out.

I tried two implementations for clustering. First one was using projection, but it has some glitches at certain angles. My final implementation is to locate the slice of the frustum where the light is at and move it coordinate to that of the slice.

## Features
* Forward+ rendering
* Clustered deferred rendering
* Blinn-Phong shading model
* 2-component normals and packed into 2 vec4s

Rendering Results
======================
## Forward+ 

![forward+3](https://user-images.githubusercontent.com/66859615/139780333-8e03fc07-c7a6-4983-95e1-3611874e3fc1.gif)

## GBuffer with Binn Phong
![g+3](https://user-images.githubusercontent.com/66859615/139780336-dec4d5cc-c2bd-454a-b48f-6de5d9751d46.gif)


Analysis
======================

## Different Methods Comparison

![20211102032411](https://user-images.githubusercontent.com/66859615/139782443-b5e4adab-52a5-4110-9763-ebc18b15e094.jpg)

In my implementation, forward+ is the worst one. Probably because the overhead cost by computing the cluster idx is too high that it is hard to get back time from reducing light iteration, but if the computing process can be accelerated by multi-threading on cpu the problem can be gone. The gbuffer one is definitely the best, we save a lot of time avoiding computing the fragment that will be culled out and the sampling of the texture is better in this case. The benefit is getting larger and larger as the we have more and more lights. Deferred shading is particularly good with large number of lgihts

## Blinn Phong Performance

The Blinn Phong result can be viewed from the above gif in the rendering result section. The Bling Phong uses a half vector between the viewing and light direction vector to replace the dot product of viewing direction and reflected light in Phone shading and this can save some calculation. We add the result generated by Bling-Phone to get specular effect. The performance cost is really low for the Bling-Phong and can almost be ignored in my case


![20211102032557](https://user-images.githubusercontent.com/66859615/139782859-aa4257c6-0658-4698-b3d2-a0858b6019b1.jpg)


## 2-component vector optimization
 To abandon the extra gbuffer for normal, I used 2-component vector with a method called sterographic projection to make the recalculation of z component more precise. We need to store pX = X / ( 1 + Z ), pY = Y / ( 1 + Z ) and when we want to get back the z component we just do  enom = 2 / ( 1 + pX * pX + pY * pY ), X = pX * denom ,Y = pY * denom,Z = denom - 1. We have an obvious performance gain at different levels of workload and it is better in large workload. This because we need to sample one less buffer each time (I pack the normal to w component of the first 2 buffers) and the computation tradeoff is pretty small.

![20211102032719](https://user-images.githubusercontent.com/66859615/139783636-da927f03-87d1-49a0-887c-b09319111ff2.jpg)



### Credits

* [Three.js](https://github.com/mrdoob/three.js) by [@mrdoob](https://github.com/mrdoob) and contributors
* [stats.js](https://github.com/mrdoob/stats.js) by [@mrdoob](https://github.com/mrdoob) and contributors
* [webgl-debug](https://github.com/KhronosGroup/WebGLDeveloperTools) by Khronos Group Inc.
* [glMatrix](https://github.com/toji/gl-matrix) by [@toji](https://github.com/toji) and contributors
* [minimal-gltf-loader](https://github.com/shrekshao/minimal-gltf-loader) by [@shrekshao](https://github.com/shrekshao)

